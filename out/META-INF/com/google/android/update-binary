#!/sbin/sh

OUTFD=$2
ZIP=$3

set -xe

ui_print() {
  echo -n -e "ui_print $1\n" > /proc/self/fd/$OUTFD
  echo -n -e "ui_print\n" > /proc/self/fd/$OUTFD
}

resolve_link() {
  if [ -z "$1" ] || [ ! -e $1 ]; then
    return 1
  fi
  local VAR=$1
  while [ -L $VAR ]; do
    VAR=$(readlink $VAR)
  done
  echo $VAR
}

rm -rf /tmp/beyondlte
mkdir -p /tmp/beyondlte
cd /tmp/beyondlte
unzip -o "$ZIP"

ui_print " - flashing kernel"
BOOT=$(resolve_link $(find /dev/block/platform -type l -name boot))
dd if=boot.img of="$BOOT"
# DTB=$(resolve_link $(find /dev/block/platform -type l -name dtb))
# ui_print " - flashing dtb"
# dd if=dtb.img of="$DTB"
# ui_print " - flashing dtbo"
# DTBO=$(resolve_link $(find /dev/block/platform -type l -name dtbo))
# dd if=dtbo.img of="$DTBO"

ui_print " "
ui_print "finished"